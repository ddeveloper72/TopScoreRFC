<!-- Rugby Match Calendar -->
<div class="calendar-container">
  <div class="calendar-header">
    <h1><i class="fa-solid fa-calendar-days"></i> Match Calendar</h1>
    <button mat-raised-button color="primary" (click)="addNewMatch()">
      <i class="fa-solid fa-plus"></i>
      Schedule Match
    </button>
  </div>

  <!-- Quick Date Navigation -->
  <div class="date-navigation">
    <button mat-icon-button (click)="previousMonth()">
      <i class="fa-solid fa-chevron-left"></i>
    </button>
    <h2>{{ currentMonth | date:'MMMM yyyy' }}</h2>
    <button mat-icon-button (click)="nextMonth()">
      <i class="fa-solid fa-chevron-right"></i>
    </button>
  </div>

  <!-- Calendar View Options -->
  <div class="view-options">
    <mat-button-toggle-group [(value)]="currentView">
      <mat-button-toggle value="month">Month</mat-button-toggle>
      <mat-button-toggle value="list">List</mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <!-- Calendar Grid (Month View) -->
  <div class="calendar-grid" *ngIf="currentView === 'month'" [@fadeInOut]>

    <!-- Week Days Header -->
    <div class="calendar-header-row">
      <div class="day-header" *ngFor="let day of weekDays">{{ day }}</div>
    </div>

    <!-- Calendar Days -->
    <div class="calendar-body">
      <div class="calendar-day" *ngFor="let day of calendarDays; let i = index" [ngClass]="{
          'other-month': !day.isCurrentMonth,
          'today': day.isToday,
          'has-matches': day.hasMatches
        }" (click)="onDayClick(day)" [@fadeInOut] [style.animation-delay]="(i * 20) + 'ms'">

        <div class="day-number">{{ day.day }}</div>

        <!-- Match indicators for this day -->
        <div class="match-indicators" *ngIf="day.hasMatches">
          <div class="match-dot" *ngFor="let match of day.matches.slice(0, 3)" [ngClass]="getMatchTimingClass(match)"
            [matTooltip]="getMatchTooltip(match)" matTooltipPosition="above" (click)="openMatchDetails(match, $event)">
          </div>
          <div class="more-matches" *ngIf="day.matches.length > 3"
            [matTooltip]="'View all ' + day.matches.length + ' matches'" matTooltipPosition="above">
            +{{ day.matches.length - 3 }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- List View -->
  <div class="matches-list" *ngIf="currentView === 'list'" [@fadeInOut]>
    <h3 [@slideInFromBottom]>Upcoming Matches</h3>

    <mat-card class="match-card" *ngFor="let match of upcomingMatches; let i = index" [@fadeInOut]
      [style.animation-delay]="(i * 100) + 'ms'">
      <mat-card-content>
        <div class="match-header">
          <div class="match-date">
            <i class="fa-solid fa-clock"></i>
            {{ match.date | date:'MMM dd, yyyy - HH:mm' }}
          </div>
          <div class="match-actions">
            <button mat-icon-button [matMenuTriggerFor]="matchMenu">
              <i class="fa-solid fa-ellipsis-vertical"></i>
            </button>
            <mat-menu #matchMenu="matMenu">
              <button mat-menu-item (click)="editMatch(match)">
                <i class="fa-solid fa-pen"></i>
                Edit
              </button>
              <button mat-menu-item (click)="startMatch(match)">
                <i class="fa-solid fa-football"></i>
                Start Game
              </button>
              <button mat-menu-item (click)="deleteMatch(match)" class="danger">
                <i class="fa-solid fa-trash"></i>
                Delete
              </button>
            </mat-menu>
          </div>
        </div>

        <!-- Match Type and Category Info -->
        <div class="match-info" [ngClass]="getMatchTypeClass(match.matchType)"
          *ngIf="match.matchType || match.homeTeamCategory">
          <div class="match-type" *ngIf="match.matchType">
            <mat-icon [style.color]="getMatchTypeColor(match.matchType)">
              {{ getMatchTypeIcon(match.matchType) }}
            </mat-icon>
            <span class="match-type-label">{{ formatMatchType(match.matchType) }}</span>
          </div>
          <div class="team-details" *ngIf="match.homeTeamCategory || match.homeTeamAgeLevel">
            <span class="team-category" *ngIf="match.homeTeamCategory">
              {{ formatTeamCategory(match.homeTeamCategory) }}
            </span>
            <span class="team-age" *ngIf="match.homeTeamAgeLevel">
              {{ match.homeTeamAgeLevel }}
            </span>
            <span class="vs-age" *ngIf="match.awayTeamAgeLevel && match.homeTeamAgeLevel !== match.awayTeamAgeLevel">
              vs {{ match.awayTeamAgeLevel }}
            </span>
          </div>
        </div>

        <div class="match-teams">
          <div class="team home-team">
            <span class="team-name">{{ match.homeTeam }}</span>
            <small class="team-type">Home</small>
          </div>
          <div class="vs-section">
            <span class="vs">VS</span>
          </div>
          <div class="team away-team">
            <span class="team-name">{{ match.awayTeam }}</span>
            <small class="team-type">Away</small>
          </div>
        </div>

        <div class="match-details">
          <div class="detail-item">
            <i class="fa-solid fa-location-dot"></i>
            {{ match.venue }}
          </div>
          <div class="detail-item" *ngIf="match.competition">
            <i class="fa-solid fa-trophy"></i>
            {{ match.competition }}
          </div>
        </div>

        <div class="match-status">
          <span class="status-badge" [ngClass]="match.status">
            {{ match.status | titlecase }}
          </span>
          <span class="days-until" *ngIf="getDaysUntil(match.date) >= 0">
            {{ getDaysUntil(match.date) === 0 ? 'Today' : getDaysUntil(match.date) + ' days' }}
          </span>
        </div>

        <!-- Database ID for reference -->
        <div class="match-id"
          style="position: absolute; bottom: 8px; right: 8px; font-size: 10px; color: #999; opacity: 0.7;">
          {{ match._id || match.id }}
        </div>
      </mat-card-content>
    </mat-card>

    <!-- No matches message -->
    <div class="no-matches" *ngIf="upcomingMatches.length === 0">
      <i class="fa-solid fa-calendar-xmark"></i>
      <h3>No upcoming matches</h3>
      <p>Schedule your first match to get started</p>
      <button mat-raised-button color="primary" (click)="addNewMatch()">
        <i class="fa-solid fa-plus"></i>
        Schedule Match
      </button>
    </div>
  </div>

  <!-- Enhanced Past Matches Section with Event Timeline -->
  <div class="past-matches" *ngIf="pastMatches.length > 0" [@fadeInOut]>
    <h3 [@slideInFromBottom]>Recent Results</h3>

    <mat-card class="enhanced-match-card" *ngFor="let match of pastMatches.slice(0, 5); let i = index" [@fadeInOut]
      [style.animation-delay]="(i * 100) + 'ms'">
      <mat-card-header>
        <div class="match-result-header">
          <div class="match-teams-result">
            <div class="team-result home">
              <span class="team-name">{{ match.homeTeam }}</span>
              <span class="team-score">{{ match.homeScore || 0 }}</span>
            </div>
            <div class="vs-result">-</div>
            <div class="team-result away">
              <span class="team-score">{{ match.awayScore || 0 }}</span>
              <span class="team-name">{{ match.awayTeam }}</span>
            </div>
          </div>
          <div class="match-meta">
            <span class="match-date">{{ match.date | date:'MMM dd, yyyy' }}</span>
            <span class="result-badge" [ngClass]="getResultClass(match)">
              {{ getMatchResult(match) }}
            </span>
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <!-- Match Type and Competition Info -->
        <div class="match-info-bar" [ngClass]="getMatchTypeClass(match.matchType)"
          *ngIf="match.matchType || match.competition">
          <div class="match-type" *ngIf="match.matchType">
            <mat-icon [style.color]="getMatchTypeColor(match.matchType)">
              {{ getMatchTypeIcon(match.matchType) }}
            </mat-icon>
            <span>{{ formatMatchType(match.matchType) }}</span>
            <span *ngIf="match.homeTeamAgeLevel"> - {{ match.homeTeamAgeLevel }}</span>
          </div>
          <div class="competition" *ngIf="match.competition">
            <i class="fa-solid fa-trophy"></i>
            {{ match.competition }}
          </div>
        </div>

        <!-- Events Timeline -->
        <div class="events-timeline" *ngIf="match.events && match.events.length > 0">
          <h4 class="timeline-title">
            <i class="fa-solid fa-clock"></i>
            Match Events
          </h4>

          <div class="timeline">
            <div class="timeline-event" *ngFor="let event of getSortedEvents(match.events)"
              [ngClass]="'event-' + event.eventType">
              <div class="event-time">{{ event.time }}</div>
              <div class="event-content">
                <div class="event-header">
                  <span class="event-icon">{{ getEventIcon(event.eventType) }}</span>
                  <span class="event-type">{{ formatEventType(event.eventType) }}</span>
                  <span class="event-team" [ngClass]="event.team">
                    {{ event.team === 'home' ? match.homeTeam : match.awayTeam }}
                  </span>
                </div>
                <div class="event-description">{{ event.description }}</div>
                <div class="event-player" *ngIf="event.ourPlayer && event.team === 'home'">
                  <i class="fa-solid fa-user"></i>
                  {{ event.ourPlayer }}
                </div>
                <div class="event-notes" *ngIf="event.notes">
                  <small>{{ event.notes }}</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Add Event Button for Completed Matches -->
          <button mat-stroked-button color="primary" class="add-event-btn" (click)="openEventManager(match)">
            <i class="fa-solid fa-plus"></i>
            Add Event
          </button>
        </div>

        <!-- No Events State -->
        <div class="no-events" *ngIf="!match.events || match.events.length === 0">
          <div class="no-events-content">
            <i class="fa-solid fa-clipboard"></i>
            <p>No match events recorded</p>
            <button mat-raised-button color="primary" (click)="openEventManager(match)">
              <i class="fa-solid fa-plus"></i>
              Add Match Events
            </button>
          </div>
        </div>

        <!-- Match Statistics Summary -->
        <div class="match-stats" *ngIf="match.events && match.events.length > 0">
          <div class="stat-item">
            <span class="stat-label">Tries</span>
            <span class="stat-value">{{ getEventCount(match.events, 'try') }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Conversions</span>
            <span class="stat-value">{{ getEventCount(match.events, 'conversion') }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Penalties</span>
            <span class="stat-value">{{ getEventCount(match.events, 'penalty') }}</span>
          </div>
        </div>

        <!-- Database ID for reference -->
        <div class="match-id">{{ match._id || match.id }}</div>
      </mat-card-content>

      <!-- Card Actions -->
      <mat-card-actions align="end">
        <button mat-raised-button color="primary" (click)="startMatch(match)" *ngIf="match.status === 'scheduled'"
          class="start-match-btn">
          <i class="fa-solid fa-play"></i>
          Start Match
        </button>
        <button mat-button (click)="openEventManager(match)">
          <i class="fa-solid fa-edit"></i>
          Manage Events
        </button>
        <button mat-button (click)="viewMatchReport(match)">
          <i class="fa-solid fa-file-alt"></i>
          Full Report
        </button>
        <button mat-icon-button [matMenuTriggerFor]="matchActionsMenu">
          <i class="fa-solid fa-ellipsis-vertical"></i>
        </button>
        <mat-menu #matchActionsMenu="matMenu">
          <button mat-menu-item (click)="editMatch(match)">
            <i class="fa-solid fa-pen"></i>
            Edit Match
          </button>
          <button mat-menu-item (click)="duplicateMatch(match)">
            <i class="fa-solid fa-copy"></i>
            Duplicate
          </button>
          <button mat-menu-item (click)="deleteMatch(match)" class="danger">
            <i class="fa-solid fa-trash"></i>
            Delete
          </button>
        </mat-menu>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
